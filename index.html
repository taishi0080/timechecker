<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>タイムチェックツール</title>
<style>
  body {
    font-family: "Helvetica", "Arial", sans-serif;
    background-color: #f9fafb;
    margin: 20px;
    text-align: center;
  }

  h1 {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }

  #titleArea {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }

  #editTitleBtn {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.2rem;
  }

  input#titleInput {
    font-size: 1.2rem;
    text-align: center;
    border: none;
    border-bottom: 1px solid #ccc;
    outline: none;
    width: 60%;
  }

  .buttonRow {
    margin-top: 15px;
  }

  .checkButton {
    width: 90%;
    max-width: 400px;
    margin: 8px auto;
    padding: 12px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .checkButton input[type="text"] {
    flex: 1;
    margin-left: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ddd;
    padding: 5px;
  }

  .checkButton:active {
    transform: scale(0.97);
    opacity: 0.8;
  }

  .b1 { background: linear-gradient(135deg,#ff5252,#ff1744); } /* ◎ */
  .b2 { background: linear-gradient(135deg,#ffb300,#ffd54f); color:black; } /* ○ */
  .b3 { background: linear-gradient(135deg,#42a5f5,#64b5f6); } /* △ */

  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 95%;
    max-width: 550px;
    background: white;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 10px;
    font-size: 0.9rem;
  }
  th {
    background-color: #f0f0f0;
  }
  tr:last-child td { border-bottom: none; }

  button.action {
    width: 90%;
    max-width: 400px;
    padding: 12px;
    margin: 10px auto;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 16px;
    cursor: pointer;
  }

  #downloadCSV {
    background: linear-gradient(135deg,#4CAF50,#81C784);
  }

  #clearData {
    background: linear-gradient(135deg,#9e9e9e,#bdbdbd);
  }
</style>
</head>
<body>

  <div id="titleArea">
    <h1 id="pageTitle">新しい記録</h1>
    <button id="editTitleBtn">✏️</button>
  </div>

  <div class="buttonRow">
    <div class="checkButton b1">
      ◎
      <input type="text" id="comment1" placeholder="コメント（任意）">
      <button id="btn1">記録</button>
    </div>
    <div class="checkButton b2">
      ○
      <input type="text" id="comment2" placeholder="コメント（任意）">
      <button id="btn2">記録</button>
    </div>
    <div class="checkButton b3">
      △
      <input type="text" id="comment3" placeholder="コメント（任意）">
      <button id="btn3">記録</button>
    </div>
  </div>

  <table id="timeTable">
    <tr><th>#</th><th>種別</th><th>コメント</th><th>時刻</th></tr>
  </table>

  <button class="action" id="downloadCSV">💾 CSVダウンロード</button>
  <button class="action" id="clearData">🗑️ 記録クリア</button>

<script>
  const table = document.getElementById("timeTable");
  const downloadCSV = document.getElementById("downloadCSV");
  const clearData = document.getElementById("clearData");
  const titleEl = document.getElementById("pageTitle");
  const editTitleBtn = document.getElementById("editTitleBtn");
  let titleInputActive = false;

  // --- ロード時にデータ復元 ---
  let records = JSON.parse(localStorage.getItem("timecheck_records") || "[]");
  let pageTitle = localStorage.getItem("timecheck_title") || "新しい記録";
  titleEl.textContent = pageTitle;
  renderTable();

  // --- ボタン動作 ---
  function addRecord(type, comment) {
    const now = new Date();
    const timeString = now.toLocaleTimeString("ja-JP");
    const rec = { type, comment, time: timeString };
    records.push(rec);
    saveData();
    renderTable();
    if (navigator.vibrate) navigator.vibrate(30);
  }

  document.getElementById("btn1").addEventListener("click", ()=> addRecord("◎", document.getElementById("comment1").value));
  document.getElementById("btn2").addEventListener("click", ()=> addRecord("○", document.getElementById("comment2").value));
  document.getElementById("btn3").addEventListener("click", ()=> addRecord("△", document.getElementById("comment3").value));

  // --- 保存 ---
  function saveData() {
    localStorage.setItem("timecheck_records", JSON.stringify(records));
    localStorage.setItem("timecheck_title", titleEl.textContent);
  }

  // --- 表再描画 ---
  function renderTable() {
    while (table.rows.length > 1) table.deleteRow(1);
    records.forEach((r, i)=>{
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = i+1;
      row.insertCell(1).textContent = r.type;
      const cmtCell = row.insertCell(2);
      const cmtInput = document.createElement("input");
      cmtInput.type = "text";
      cmtInput.value = r.comment || "";
      cmtInput.style.width = "90%";
      cmtInput.addEventListener("change", ()=>{
        r.comment = cmtInput.value;
        saveData();
      });
      cmtCell.appendChild(cmtInput);
      row.insertCell(3).textContent = r.time;
    });
  }

  // --- タイトル編集 ---
  editTitleBtn.addEventListener("click", ()=>{
    if (titleInputActive) return;
    titleInputActive = true;
    const input = document.createElement("input");
    input.id = "titleInput";
    input.value = titleEl.textContent;
    titleEl.replaceWith(input);
    input.focus();
    input.addEventListener("blur", ()=>{
      const newTitle = input.value.trim() || "新しい記録";
      const newH1 = document.createElement("h1");
      newH1.id = "pageTitle";
      newH1.textContent = newTitle;
      input.replaceWith(newH1);
      titleInputActive = false;
      saveData();
      titleEl = newH1;
    });
  });

  // --- CSV出力 ---
  downloadCSV.addEventListener("click", ()=>{
    if (records.length === 0) {
      alert("記録がありません。");
      return;
    }
    const title = localStorage.getItem("timecheck_title") || "記録";
    let csv = "No,種別,コメント,時刻\n";
    records.forEach((r,i)=>{
      const clean = (t)=> t.replace(/,/g," ");
      csv += `${i+1},${r.type},${clean(r.comment)},${r.time}\n`;
    });
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${title}.csv`;
    link.click();
  });

  // --- データクリア ---
  clearData.addEventListener("click", ()=>{
    if (!confirm("本当にすべての記録を削除しますか？")) return;
    if (!confirm("この操作は取り消せません。よろしいですか？")) return;
    records = [];
    localStorage.removeItem("timecheck_records");
    renderTable();
  });
</script>

</body>
</html>

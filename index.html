<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>タイムチェック</title>
<style>
  body {
    font-family: "Helvetica", "Arial", sans-serif;
    background-color: #f9fafb;
    margin: 20px;
    text-align: center;
  }

  #titleArea {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }

  h1 {
    font-size: 1.5rem;
    margin: 10px 0;
  }

  #editTitleBtn {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.2rem;
  }

  input#titleInput {
    font-size: 1.2rem;
    text-align: center;
    border: none;
    border-bottom: 1px solid #ccc;
    outline: none;
    width: 60%;
  }

  /* ◎／○／△ボタン 横並び */
  .buttonRow {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .checkButton {
    flex: 1;
    min-width: 90px;
    max-width: 150px;
    padding: 14px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }

  .checkButton:active {
    transform: scale(0.97);
    opacity: 0.85;
  }

  .b1 { background: linear-gradient(135deg,#ff5252,#ff1744); } /* ◎ */
  .b2 { background: linear-gradient(135deg,#ffb300,#ffd54f); color:black; } /* ○ */
  .b3 { background: linear-gradient(135deg,#42a5f5,#64b5f6); } /* △ */

  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 95%;
    max-width: 550px;
    background: white;
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
    font-size: 0.9rem;
  }

  th {
    background-color: #f0f0f0;
  }

  input.commentEdit {
    width: 90%;
    font-size: 14px;
    padding: 3px;
  }

  .delBtn {
    background: none;
    border: none;
    color: #e53935;
    font-size: 1.1rem;
    cursor: pointer;
  }

  button.action {
    width: 90%;
    max-width: 400px;
    padding: 12px;
    margin: 10px auto;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 16px;
    cursor: pointer;
  }

  #downloadCSV {
    background: linear-gradient(135deg,#4CAF50,#81C784);
  }

  /* 🔴 全削除ボタンを赤色に */
  #clearData {
    background: linear-gradient(135deg,#e53935,#d32f2f);
  }
</style>
</head>
<body>

  <div id="titleArea">
    <h1 id="pageTitle">新しい記録</h1>
    <button id="editTitleBtn">✏️</button>
  </div>

  <!-- ◎／○／△ 横並び -->
  <div class="buttonRow">
    <button class="checkButton b1" id="btn1">◎ 記録</button>
    <button class="checkButton b2" id="btn2">○ 記録</button>
    <button class="checkButton b3" id="btn3">△ 記録</button>
  </div>

  <table id="timeTable">
    <tr><th>#</th><th>種別</th><th>コメント</th><th>時刻</th><th></th></tr>
  </table>

  <button class="action" id="downloadCSV">💾 CSVダウンロード</button>
  <button class="action" id="clearData">🗑️ 全削除</button>

<script>
  const table = document.getElementById("timeTable");
  const downloadCSV = document.getElementById("downloadCSV");
  const clearData = document.getElementById("clearData");
  let titleEl = document.getElementById("pageTitle");
  const editTitleBtn = document.getElementById("editTitleBtn");
  let titleInputActive = false;

  let records = JSON.parse(localStorage.getItem("timecheck_records") || "[]");
  let pageTitle = localStorage.getItem("timecheck_title") || "新しい記録";
  titleEl.textContent = pageTitle;
  renderTable();

  function addRecord(type) {
    const now = new Date();
    const timeString = now.toLocaleTimeString("ja-JP");
    records.push({ type, comment: "", time: timeString });
    saveData();
    renderTable();
    if (navigator.vibrate) navigator.vibrate(30);
  }

  document.getElementById("btn1").addEventListener("click", ()=> addRecord("◎"));
  document.getElementById("btn2").addEventListener("click", ()=> addRecord("○"));
  document.getElementById("btn3").addEventListener("click", ()=> addRecord("△"));

  function saveData() {
    localStorage.setItem("timecheck_records", JSON.stringify(records));
    localStorage.setItem("timecheck_title", titleEl.textContent);
  }

  function renderTable() {
    while (table.rows.length > 1) table.deleteRow(1);
    records.forEach((r, i)=>{
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = i+1;
      row.insertCell(1).textContent = r.type;
      const cmtCell = row.insertCell(2);
      const input = document.createElement("input");
      input.type = "text";
      input.className = "commentEdit";
      input.value = r.comment || "";
      input.addEventListener("change", ()=>{
        r.comment = input.value;
        saveData();
      });
      cmtCell.appendChild(input);
      row.insertCell(3).textContent = r.time;
      const delCell = row.insertCell(4);
      const delBtn = document.createElement("button");
      delBtn.textContent = "🗑️";
      delBtn.className = "delBtn";
      delBtn.onclick = ()=>{
        if (confirm("この記録を削除しますか？")) {
          records.splice(i,1);
          saveData();
          renderTable();
        }
      };
      delCell.appendChild(delBtn);
    });
  }

  // タイトル編集
  editTitleBtn.addEventListener("click", ()=>{
    if (titleInputActive) return;
    titleInputActive = true;
    const input = document.createElement("input");
    input.id = "titleInput";
    input.value = titleEl.textContent;
    titleEl.replaceWith(input);
    input.focus();
    input.addEventListener("blur", ()=>{
      const newTitle = input.value.trim() || "新しい記録";
      const newH1 = document.createElement("h1");
      newH1.id = "pageTitle";
      newH1.textContent = newTitle;
      input.replaceWith(newH1);
      titleInputActive = false;
      titleEl = newH1;
      saveData();
    });
  });

  // CSV出力
  downloadCSV.addEventListener("click", ()=>{
    if (records.length === 0) {
      alert("記録がありません。");
      return;
    }
    const title = localStorage.getItem("timecheck_title") || "記録";
    let csv = "No,種別,コメント,時刻\n";
    records.forEach((r,i)=>{
      const clean = (t)=> t.replace(/,/g," ");
      csv += `${i+1},${r.type},${clean(r.comment)},${r.time}\n`;
    });
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${title}.csv`;
    link.click();
  });

  // 全削除（二重確認、報告ダイアログなし）
  clearData.addEventListener("click", ()=>{
    if (!confirm("全ての記録を削除しますか？")) return;
    if (!confirm("この操作は取り消せません。本当に実行しますか？")) return;
    records = [];
    localStorage.removeItem("timecheck_records");
    renderTable();
  });
</script>

</body>
</html>
